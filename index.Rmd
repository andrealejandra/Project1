---
title: 'Project 1: Wrangling, Exploration, Visualization'
author: "SDS322E"
date: ''
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = "center", warning = F, message = F,
tidy=TRUE, tidy.opts=list(width.cutoff=60), R.options=list(max.print=100))
```

## Health Indicators in Texas Counties

### Andrea Virgen AAV782

#### Introduction 

I'm interested to see how and if there are correlations between obesity rates, diabetes, and rates of sufficient physical activity. I would infer that counties with the highest rates of obesity and diabetes would have lower life expectancy, but it remains to be seen if higher rates of sufficient exercise compensates for these rates. The first dataset(phys) shows percentage prevalence of each location's population that achieves a sufficient amount of physical activity - specificity of measurement or sample size is unknown. The second dataset(obesity) shows percentage prevalence of obesity(criteria not given), normalized by age. The third dataset(diabetes) houses the percentage of people who reported a formal diagnosis or elevated levels of FPG/A1C, standardized by age. The final dataset(life) houses life expectancies by county.

```{R}
library(readr)
library(tidyverse)
library(readxl)

phys <- read_excel("IHME_county_data_LifeExpectancy_Obesity_PhysicalActivity_TEXAS.xls", 
    sheet = "Physical Activity")

obesity <- read_excel("IHME_county_data_LifeExpectancy_Obesity_PhysicalActivity_TEXAS.xls", 
    sheet = "Obesity")

diabetes <- read_excel("IHME_county_data_Diabetes_TEXAS.xlsx", 
    sheet = "Total")

life <- read_excel("IHME_county_data_LifeExpectancy_Obesity_PhysicalActivity_TEXAS.xls", 
    sheet = "Life Expectancy")

```

#### Tidying: Reshaping

Because these datasets have one numeric variable each, I am reshaping them to be combined on the basis of Location, Sex, and Year. The life expectancy(life) dataset was collected from years that do not overlap with the data from the other three datasets, so I will be taking the average from the data available for a later comparison with the other variables.

```{R}

life %>%
  select(-14:15) %>%
  pivot_longer(-1, names_to="desc", values_to="Life Expectancy") %>%
  rename("Location" = "State/County") %>%
  separate(desc, into = c("desc2", "Year"), sep=", ") %>%
  separate(desc2, into=c("Sex", NA)) %>%
  filter(Sex!="Difference") %>%
  group_by(Location, Sex) %>%
  transmute("Avg Life Expectancy"= sum(`Life Expectancy`)/n()) %>%
  distinct() -> life

phys %>%
  select(1:7)%>%
  pivot_longer(c(2:7), names_to = "desc", values_to= "Percent Active") %>%
  separate(desc, into=c("desc2", "year"), sep=", ") %>%
  separate(desc2, into =c("Sex",NA,NA,NA,NA)) %>%
  separate(year, into="Year") %>%
  rename(Location = "State/County") -> phys

obesity %>%
  select(1:7) %>%
  pivot_longer(c(2:7), names_to = "desc", values_to= "Percent Obese") %>%
  separate(desc, into =c("desc2", "Year"), sep=", ") %>%
  separate(desc2, into=c("Sex", NA, NA)) %>%
  separate(Year, into="Year") %>%
  rename(Location = "State/County") -> obesity

# diabetes %>%
#   pivot_wider(names_from = "Location", values_from="FIPS") %>%
#   rename("United States" = "National") %>%
#   pivot_longer("United States":"Zavala County", names_to="Location", values_to="FIPS") %>%
#   pivot_longer(1:45, names_to = "desc", values_to= "Percent Diabetic") %>%
#   separate(desc, into = c(NA, "Year", "Sex")) %>%
#   separate(Sex, into = c("Sex", NA), sep="s") %>%
#   separate(Location, into =c("Location", NA), sep=" County") %>%
#   select(1, 3:5)-> diabetes

  
```

    
#### Joining/Merging

```{R}
inner_join(phys, obesity, by=c("Location", "Sex", "Year")) %>%
  left_join(life, by=c("Location", "Sex")) -> health_indicators

  

```

Because phys and obesity are the same length, I can perform an inner join without losing any data. My life dataset is averages over a span of 25 years, so I will have repeated numbers for each Location after perfoming a left join to the previously inner-joined dataset.

####  Wrangling

```{R}

health_indicators %>%
  na.omit -> health_indicators
# highest life expectancy
health_indicators %>%
  arrange(desc(`Avg Life Expectancy`)) %>%
  select(1:2, 6) %>%
  group_by(Location, Sex) %>%
  filter(Sex=="Male") %>%
  distinct()

health_indicators %>%
  arrange(desc(`Avg Life Expectancy`)) %>%
  select(1:2, 6) %>%
  group_by(Location, Sex) %>%
  filter(Sex=="Female") %>%
  distinct()
  
# average obesity rates by year
health_indicators %>%
  filter(Location!=c("United States", "Texas")) %>%
  group_by(Year, Sex) %>%
  summarize(`Overall Average Percent of Population Considered Obese` = sum(`Percent Obese`)/n(), `Overall Average Percent of Population Considered Sufficiently Active` = sum(`Percent Active`)/n())

# highest performers above the mean
health_indicators %>%
  group_by(Location) %>%
  filter(`Percent Active` > mean(`Percent Active`)) %>%
  arrange(desc(`Percent Active`))

# how often does active percent exceed obese percent?
health_indicators %>%
  mutate(`Higher Percent` = ifelse(`Percent Active` > `Percent Obese`, "Active", "Obese")) -> comparison

comparison %>%
  filter(`Higher Percent` == "Obese") %>%
  arrange(desc(`Percent Obese`)) %>%
  str_match_all("20[0-9]{2}") 


```



#### Visualizing

```{R}
health_indicators %>%
  ggplot(aes(`Avg Life Expectancy`, `Percent Active`, color=Sex)) + geom_point() + scale_color_brewer(palette="Set1") + geom_smooth() + xlab("Average Life Expectancy (1985 - ")
```

Your discussion of plot 1

```{R}
comparison %>%
  ggplot(aes(`Higher Percent`, fill = `Higher Percent`)) + geom_bar() + theme_dark() + ylab("Number of Counties") + xlab("Larger Percent of Population") + facet_grid(~Year)
```

Your discussion of plot 2

```{R}
health_indicators %>%
  ggplot(aes(`Percent Obese`, fill = Year)) + geom_density() + xlab("Percent of Population Considered Obese") + facet_grid(~Sex)
```

Your discussion of plot 3

#### Concluding Remarks






